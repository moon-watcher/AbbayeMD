/***
 *    - Feel free to do anything you want* with this code, consider it as PUBLIC DOMAIN -
 *               ... but be careful, this code is dark and full of terrors.
 *
 *                (*) NOT ALLOW TO USE THIS CODE FOR COMMERCIAL PURPOSES
 *
 *
 *                   +
 *                  m       +++++++++
 *                   ++++++++m+++++++m+
 *                ++++    ++mmmmmmmmmmmm
 *             ++m+     +mm+++++++++++mmm+
 *              m+ +m++mm+       ++    +mmm            ++++          ++++
 *             m  m+  +m   +m++mmm      +mmm         ++++ mm       ++++ mm
 *             m  m   m   mm+ +mm        mmm+  +++ +m++  mm ++++ +m++  mm +
 *    +   +    +m +++ m ++m+ +mmm        mmmm    m+mm+     +   m+mm+     +
 *     m+m      +m++   m ++  mmmm        mmmm+   mmmm          mmmm
 *      mm mm      +++++m    mmmm        mmmm m  mmm++mm++     mmm++mm++       +mmmm+++   +m +mmmmm++      +m+
 *      mm +        +++++++++mmmm        mmmm++  mmm+m+mmmm    mmm+m+mmmm    ++    +m+  +mmmm+    ++     +mmmmm+
 *      mm        ++   ++m++ mmmmmmmm++  mmmm+   mmm+   +mmm   mmm+   +mmm  ++     ++    mmm     ++     m   +mmm
 *      mm ++     m   +    +mmmmm  +mmmm+mmmm    mmm ++++mmm   mmm ++++mmm  m  ++  m     mmm ++ +m     m   ++ mm
 *      mm+++m     mmm+   m  mmmm +      mmmm    mmmm    mmm   mmmm    mmm mm m   mm     mmmm   mm    mm  m  ++
 *      +        m+  +mm+ +  mmmm m      mmmm    mmm     mm+   mmm     mm+ mm+m   mm++   mmmm   mmm+  mm+ m +
 *              m  ++   mmm  mmm mmm     mmmm    mmm    mm+    mmm    mm+  mmm++++mmm+   mmm++  mmm+  +mm+ ++  +
 *              m  m+++++  ++++   m      mmmm    +mmm++m+      +mmm++m+     mmmm+++mmm++ mmmm+m+ mmm   +mmmm++m
 *              ++  +mmmmmm++++++++m+    mmmm+    +mmm+         +mmm+        ++m+  +mm+   +mmm    mmm    ++mmm
 *               +++  +++mmmm+      +m+ +mmmmm           +m+m                                      mmm
 *                  +++++mm++mm+++++++mmmmmmm           mm  ++                               +++++  mm
 *               ++    ++++  mm     m  +m+mmmm          mm+      +     +  +             +    +   m  m+
 *               ++++++   m +++ m+  m   +m +            +mm+   +m+m+ +mm++               +m+     m ++
 *                         m   +   +++++ +            ++ + ++ mm  +m mm ++                 ++m+++++
 *                          +++++++++                 m+m   m mm+m+   +++mm       +m+
 *                               m+                   mmm+ m  mm+  + ++mmm+  ++ +mm
 *                                                     +mmm    +mm+ m++m+      mmm
 *                                                       +                     mmm
 *                                    +    ++   +++  +                +   +   +mmm+++      +   +
 *                                  +mm+++mmm+++++mmm    ++ +mm+    +mm  mmm+  mmm      ++mmmm+
 *                                 +mmm+   mmm   +mm   +m+ +++mmm+ +mmm++ +mm  mmm    +m+++++
 *                                  mmm   +mmm ++mm   +mmmmmmmmmmm+ mmm+  ++   mmm   mmm+
 *                                  mmm ++ mmmm  mm   m+ +mmmmm+ +m mmm+ m     mmm   mmmm++mmmmm+
 *                                  mmm++  mmm   mm+  m+  +m+m+  +m mmm   +    mmm    ++mm++ +mmm
 *                                  mmmm   mmm   mmm   +mmm + mmm+  mmm        mmm        +++ mm+
 *                                  mmmm+  mmm+  +mmm +  mmmmmmm    mmm        mmm     +++++m m+
 *                                  mmm+   mm+    mmmm    + + +     mm++       mm++  +++++mmm+
 *                                  ++     +       ++               +          +           +
 *
 *
 * Original game by Locomalito & Gryzor87, released for PC, CHECK OUT THIS! [http://locomalito.com/]
 *
 * @CODE:                     =>  Mun                           | Twitter: @MoonWatcherMD
 * @PROJECT:                  =>  #AbbayeMD
 * @START-DATE:               =>  2011XXXX
 * @LAST-UPDATE:              =>  20170412
 * @LIB:                      =>  SGDK (v1.22a) by Stephane Dallongeville
 *
 *
 *
 * --------------------------------------------------------------------------------------------------------------------------------
 *  SPECIAL THANKS TO
 * --------------------------------------------------------------------------------------------------------------------------------
 *
 * @GODFATHER-OF-THIS-RELEASE => Leander                        | Twitter: @leanderpixel      | Mail:                     |Notes:
 *
 * @MSX-SKIN                  => Gerardo Herce                  | Twitter: @pipagerardo       | Mail:                     |Notes:
 * @GB-SKIN                   => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 * @PCW-SKIN                  => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 * @CGA-SKIN                  => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 * @MD-SKIN                   => Dani Nevado                    | Twitter: @DanySnowyman      | Mail:                     |Notes:
 * @C64-SKIN                  => Igor Errazkin                  | Twitter: @Errazking         | Mail:                     |Notes:
 * @MUSIC                     => DaRkHoRaCe                     | Twitter: @oongamoonga       | Mail:                     |Notes:
 * @SFX                       => DaRkHoRaCe                     | Twitter: @oongamoonga       | Mail:                     |Notes:
 * @C64-MUSIC                 => Manuel Gomez "Baron Ashler"    | Twitter: @kbfactory         | Mail:                     |Notes:
 *
 * @BETA-TESING               => Alfonso Martínez               | Twitter: @_SrPresley_       | Mail:                     |Notes:
 * @BETA-TESING               => Ruben Vaquer                   | Twitter: @TitoAdol3         | Mail:                     |Notes:
 * @BETA-TESING               => Jimy                           | Twitter: @TodoMegaDrive     | Mail:                     |Notes:
 *
 * @SPECIAL-THANKS-TO         => Stephane Dallongeville         | Twitter: @MegadriveDev      | Mail:                     |Notes:
 * @SPECIAL-THANKS-TO         => José Zanni                     | Twitter: @josepzin          | Mail:                     |Notes:
 * @SPECIAL-THANKS-TO         => David Lara                     | Twitter: @nevat             | Mail:                     |Notes:
 *
 * @CRUSADER-MODE             => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 *
 *
 *
 * --------------------------------------------------------------------------------------------------------------------------------
 *  PLAYONRETRO'S PHYSICAL RELEASE
 * --------------------------------------------------------------------------------------------------------------------------------
 *
 * @ILLUSTRATIONS             => Urza                           | Twitter: @Urza2             | Mail:                     |Notes:
 * @COVER                     => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 * @INSTRUCTION-MANUAL        => Felipe Monge Corbalán          | Twitter: @vakapp            | Mail:                     |Notes:
 *
 *
 *
 * --------------------------------------------------------------------------------------------------------------------------------
 *  HOW TO COMPILE
 * --------------------------------------------------------------------------------------------------------------------------------
 *
 * Sega Genesis/Megadrive version of l'Abbaye des morts was created using SGDK v1.22a and GenRes v1.1.
 *
 *  - Go gendev.spritesmind.net/page-genres.html
 *  - Download GenRes v1.1
 *  - Extract and replace all genres.* files in the zip into SGDK's bin directory
 *  - Compile #AbbayeMD
 *  - Ta-dah!
 *
 *
 *
 * --------------------------------------------------------------------------------------------------------------------------------
 *  KNOWN BUGS
 * --------------------------------------------------------------------------------------------------------------------------------
 *
 * - Several music issues related to the sound driver
 * - You can not pass (and fall) between narrow blocks at room 4,3
 *
 *
 *
 * --------------------------------------------------------------------------------------------------------------------------------
 *  CHANGELOG
 * --------------------------------------------------------------------------------------------------------------------------------
 * 12-04-2017 » First release
 * --------------------------------------------------------------------------------------------------------------------------------
 *
 */



#include "../inc/include.h"



static u16 demo1()
{
	if ( !joy1_pressed_a )
	{
		return 0;
	}

	extern const struct genresTiles demo_lightfold64;

	u16 pos  = 16;
	u16 size = demo_lightfold64.width * demo_lightfold64.height;
	u16 j, i = 0;
	u16 palette [ 16 ];


	SYS_disableInts();
	VDP_loadTileData ( demo_lightfold64.tiles, pos, size, 0 );
	VDP_fillTileMapRectInc ( PLAN_B, TILE_ATTR_FULL(PAL0, 0, 0, 0, pos), 0, 0, demo_lightfold64.width, demo_lightfold64.height );
	VDP_setPalette ( PAL0, palette_black );
	SYS_enableInts();

	while ( 1 )
	{
		for ( j=0; j<16; j++ )
		{
			u16 val = ( ( i % 16 ) + j ) % 16;

			palette [ val ] = demo_lightfold64.pal [ j ];
		}

		SYS_disableInts();
		VDP_setPaletteColors (  0, palette, 16 );
		SYS_enableInts();

		waitMs ( 40 );

		JoyReader_update();

		if ( joy1_pressed_abc )
		{
			break;
		}

		VDP_waitVSync();

		++i;
	}

	VDP_fadeOutAll ( 30, 0 );

	return 1;
}


static u16 demo2 ( )
{
	if ( !joy1_pressed_b )
	{
		return 0;
	}

	extern const struct genresTiles demo_rainbars16b;

	VDP_setScreenWidth256();
	VDP_setPlanSize(32,32);

	u16 pos  = 16;
	u16 size = demo_rainbars16b.width * demo_rainbars16b.height;

	SYS_disableInts();
	VDP_loadTileData ( demo_rainbars16b.tiles, pos, size, 0 );
	VDP_fillTileMapRectInc ( PLAN_B, TILE_ATTR_FULL(PAL0, 0, 0, 0, pos), 0, 0, demo_rainbars16b.width, demo_rainbars16b.height );
	SYS_enableInts();

	u16 palette [ 16 ];
	u16 j, i = 0;

	while ( 1 )
	{
		if ( i % 1 == 0 )
		{
			for ( j=0; j<16; j++ )
			{
				u16 val = ( ( i % 16 ) + j ) % 16;

				palette [ val ] = demo_rainbars16b.pal [ j ];
			}
		}


		SYS_disableInts();
		VDP_setHorizontalScroll ( PLAN_B, -i );
		VDP_setVerticalScroll ( PLAN_B, -i*8 );
		VDP_setPaletteColors (  0, palette, 16 );
		SYS_enableInts();

		waitMs(30);


		JoyReader_update();

		if ( joy1_pressed_abc )
		{
			break;
		}


		VDP_waitVSync();

		++i;
	}

	VDP_fadeOutAll ( 30, 0 );

	return 1;
}


static u16 monos()
{
	if ( !joy1_pressed_c )
	{
		return 0;
	}

	extern const Image ob_title_monos_mi;

	SYS_disableInts();
	VDP_loadTileSet ( ob_title_monos_mi.tileset, 16, 0 );
	VDP_setPalette ( PAL1, ob_title_monos_mi.palette->data );
	SYS_enableInts();

	u16 x = 0;
	u16 y = 0;

	while ( 1 )
	{
		SYS_disableInts();
		VDP_setMapEx ( PLAN_A, ob_title_monos_mi.map, TILE_ATTR_FULL(PAL1,0,0,0,16), 14, 10, x*13, y*6, 13, 6 );
		SYS_enableInts();

		waitMs(100);

		++x;

		if ( x == 10 )
		{
			x = 0;
			++y;
		}

		if ( x == 6 && y == 6 )
		{
			x = 0;
			y = 0;
		}

		JoyReader_update();

		if ( joy1_pressed_abc )
		{
			break;
		}

		VDP_waitVSync();
	}

	VDP_fadeOutAll ( 30, 0 );

	return 1;
}



static bool force_jack ( )
{
	return ( bool ) ( joy1_pressed_start );
}



void psg_test ()
{
	#include "../res/all/psg.h"
	#include "../../libs/psg.h"

	//const u16 back_size=175;

	const u8 back_data[175]=
	{
		0x00,0x01,0x00,0x04,0x03,0x00,0x0b,0x00,0x4f,0x00,0x93,0x00,0xc0,0xd5,0x80,0xe3,
		0x80,0xd5,0x01,0x80,0xe3,0x80,0xd5,0x80,0xc7,0x80,0xd5,0x80,0xe3,0x80,0xd5,0x80,
		0xc7,0x80,0xd5,0x80,0xe3,0x80,0xd5,0x80,0xc7,0xc4,0xd5,0x80,0xe3,0x80,0xd5,0x43,
		0x80,0xe3,0x80,0xd5,0xfc,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,0x80,0x00,0x80,0x0e,
		0x80,0x00,0x83,0xf2,0x80,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,0x80,0x00,0x00,0x01,
		0xc0,0xd5,0x80,0xe3,0x80,0xd5,0x01,0x80,0xe3,0x80,0xd5,0x80,0xc7,0x80,0xd5,0x80,
		0xe3,0x80,0xd5,0x80,0xc7,0x80,0xd5,0x80,0xe3,0x80,0xd5,0x80,0xc7,0xc4,0xd5,0x80,
		0xe3,0x80,0xd5,0x43,0x80,0xe3,0x80,0xd5,0xfc,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,
		0x80,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,0x80,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,
		0x80,0x00,0x00,0x02,0xfc,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,0x80,0x00,0x80,0x0e,
		0x80,0x00,0x83,0xf2,0x80,0x00,0x80,0x0e,0x80,0x00,0x83,0xf2,0x80,0x00,0x00
	};


	while ( 1 )
	{
		psg_play ( (u8*)psg_item,     0 ); waitSc ( 2 );
		psg_play ( (u8*)psg_onedeath, 0 ); waitSc ( 2 );
		psg_play ( (u8*)psg_door,     0 ); waitSc ( 2 );
		psg_play ( (u8*)back_data,    0 ); waitSc ( 2 );
	}
}




static _voidCallback *vint_callback ( )
{
	//psg_callback();

	SND_setMusicTempo_XGM ( 60 );

	if ( DEV )
	{
//		showMcb();
//		showOcb();
//		showNbObjects();
//		showZ80Load();
//		showFps();
	}

	return 0;
}






static _voidCallback *psgtest_callback ( )
{
//	psg_callback();
	return 0;
}

void psgtest ()
{
//	#include "../res/all/sfx.h"
//	#include "../data/all/sfx/fx5.h"
//
//	PSG_init ( );
//
	SYS_setVIntCallback ( (_voidCallback*) psgtest_callback );
//
//	psg_play ( fx5_data, 0 );
//
//	while(1)
//	{
//		VDP_waitVSync();
//	}
}




int main ( int argc, char *argv[] )
{
//	psgtest ();


//	// 0 is soft reset
//	if ( argc == 0 )
//	{
//		const u16 palette_black_64[64] = { [0 ... 63] = 0x0000 };
//
//		VDP_setPaletteColors ( 0, (u16*) palette_black_64, 64 );
//
////		displayOff(0);
////		VDP_drawText ( "You pressed reset", 11, 9 );
//
//		_start_entry(); // even more reset
//		MEM_init();
//	}
//
////	sd_reset();
////	SYS_reset();
////	SYS_assertReset(); // makes gensKmod crash, WTF?!


	//VDP_init();

	//Z80_loadDriver ( Z80_DRIVER_XGM, true );
	//SND_setForceDelayDMA_XGM (true);
	//SND_set68KBUSProtection_XGM ( TRUE );

//	Z80_init();
//	Z80_loadDriver ( Z80_DRIVER_VGM, true );


    displayInit ( );
    displayOff ( 0 );
	dev_init ( 0, 0 );
    sfxInit ( );
    JOY_setSupport ( PORT_1, JOY_SUPPORT_6BTN );
    JoyReader_init ( 1 );
    SYS_setVIntCallback ( (_voidCallback*) vint_callback );
	VDP_setScreenWidth320 ( );
	VDP_setPlanSize ( 64, 32 );

	//psg_test ();

	inSoundTest = false;
	game.version = VERSION_MD;



//						dev_init ( 1, 1 );
//						game.version = VERSION_GB;




	JoyReader_update();

	bool force = false;

	if ( monos() || demo1() || demo2() || (force = force_jack()) ) ;

	VDP_setScreenWidth320 ( );
	VDP_setPlanSize ( 64, 32 );

    screen_disclaimer ( force );
    screen_sega ( );

    displayOff(0);
    resetScroll();
	resetScreen();
	VDP_setScreenWidth256 ( );
	VDP_setPlanSize ( 32, 64 );


//				scrollSet ( SCROLL_INIT );
//				game.version = VERSION_PC;

//				screen_credits ( );
//				screen_title ( );
//				screen_info ( );
//				screen_burning ( );
//				screen_ending ( );
//				screen_tfp ( );
//				screen_prologue ( );
//				screen_gameover ( );
//				screen_soundtest();




	setRandomSeed ( vtimer );
    session_init ( );

	while ( TRUE )
    {
    	displayOff(0);

    	preparePal ( PAL0, (u16*) palette_black );
    	preparePal ( PAL1, (u16*) palette_black );
    	preparePal ( PAL2, (u16*) palette_black );
    	preparePal ( PAL3, (u16*) palette_black );

		musicInit ( );

    	screen_playonretro ( );
        screen_credits ( );

		if ( screen_title ( ) )
        {
        	VDP_setPlanSize ( 32, 64 );

            screen_prologue ( );
            cm_init ( );
            checkpoint_init ( );
            game_init ( );
            switch_init ( );
            hudInit ( );
            scrollSet ( SCROLL_INIT );
            itemManagerInit ( &waItems );

//play_sfx(SFX_SWITCH);waitMs(1000);

//						// desde el inicio para matar a Satán
//						game.version  = VERSION_MD;
//						session.level = 1;
//						game.room.x = 0;
//						game.room.y = 3;
//						//

//						// activate the crusader mode
//						game.version  = VERSION_MD;
//						session.level = 1;
//						hudIncHearts(-8);
//						game.crusader = false;
//						cm_activate();
//						game.status = GAME_STATUS_OK;
//						//

//						game.room.x = 3;
//						game.room.y = 2;
//						game.version  = VERSION_GB;




            playerInit ( &player );
            invertedCross = false;

            game_loop ( );

            JoyReader_init ( 1 );

            itemManagerEnd ( &waItems );

			mute ( );

            if ( game.status == GAME_STATUS_ENDING )
            {
                screen_burning ( );
                screen_ending ( );
                //screen_credits ( );
                screen_tfp ( ); // thanks for playing
            }

            if ( game.status == GAME_STATUS_GAMEOVER )
            {
                screen_gameover ( );
            }

            mute ( );
        }
        else
        {
            //screen_info ( );
            //screen_demo ( );
        }
    }


    return 0;
}
